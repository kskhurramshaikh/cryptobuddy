<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>CryptoBuddy — AI Signals & Market Analysis</title>
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    body { background:#061021; color:#cbd5e1; font-family:Inter,ui-sans-serif; }
    .rounded-xl { border-radius:1rem; }
    .muted { color:#94a3b8; }
    .sel-icon { width:20px; height:20px; margin-right:8px; }

    /* Donut center */
    .donut-center {
      position:absolute;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      flex-direction:column;
      pointer-events:none;
    }
  </style>
</head>

<body class="p-6">
  <div class="max-w-6xl mx-auto">
    <h1 class="text-2xl text-white font-semibold mb-4">CryptoBuddy — Trade Terminal</h1>

    <div class="grid lg:grid-cols-3 gap-6">
      <!-- LEFT SIDE -->
      <section class="lg:col-span-2 space-y-4">

        <!-- SEARCH -->
        <div>
          <label class="text-sm muted">Search symbol</label>

          <div class="relative mt-3">
            <div id="inputIconWrap"
              class="bg-transparent border border-slate-800 rounded-xl px-3 py-2 flex items-center">
              <img id="selectedIconSmall" src="" class="sel-icon hidden"/>
              <input id="symbolInput"
                placeholder="Type or search (BTC, ETH, SOL...)"
                class="bg-transparent text-white placeholder:text-slate-500 w-full"
                autocomplete="off"/>
            </div>

            <div id="typeahead"
              class="absolute left-0 right-0 mt-2 bg-[#071026] border border-slate-800 rounded-xl hidden z-40 max-h-48 overflow-y-auto">
            </div>
          </div>

          <!-- SERVICE -->
          <div class="mt-4 p-4 rounded-xl bg-[#071024] border border-slate-800">
            <label class="text-sm text-slate-300">Choose Service</label>
            <select id="service"
              class="w-full mt-2 bg-[#091125] border border-slate-800 text-slate-200 p-3 rounded-xl">
              <option value="signal-simple">Simple Signal</option>
              <option value="signal">Detailed Signal</option>
              <option value="analysis-simple">Simple Market Analysis</option>
              <option value="analysis">Detailed Market Analysis</option>
            </select>
          </div>

          <!-- PRICE + INFO -->
          <div class="mt-4 flex gap-4">

            <div class="w-28 p-3 rounded-lg bg-[#091125] border border-slate-800">
              <div class="text-xs text-slate-400">Price</div>
              <div id="priceBadge" class="text-lg font-semibold mt-1">0.10 USDC</div>
            </div>

            <div class="flex-1 p-3 rounded-lg bg-[#071024] border border-slate-800">
              <div id="descTitle" class="text-sm text-slate-300">Select a symbol to see what you get.</div>
              <div id="descSub" class="text-xs text-slate-500 mt-2">AI Signal or Market Analysis output</div>
            </div>

          </div>
        </div>

        <!-- PAY + RIGHT RESULT BLOCK -->
        <div class="grid lg:grid-cols-2 gap-4">

          <!-- PAY BLOCK -->
          <div class="p-6 rounded-xl bg-[#071022] border border-slate-800">
            <div class="flex items-center gap-3">
              <img id="selectedIconLarge" src="" class="w-10 h-10 rounded-md hidden"/>
              <div>
                <div id="selectedSymbol" class="text-lg font-semibold">—</div>
                <div id="ticker" class="text-sm muted">CryptoBuddy AI</div>
              </div>
            </div>

            <div class="mt-6">
              <button id="payBtn"
                class="w-full bg-indigo-600 text-white py-3 rounded-xl disabled:opacity-60"
                disabled>
                Pay & Unlock
              </button>
              <div id="payLabel" class="text-xs muted mt-2">Connect wallet to sign</div>
            </div>
          </div>

          <!-- RESULT BLOCK -->
          <div class="p-6 rounded-xl bg-[#071022] border border-slate-800">
            <div id="resultTop">
              <div>
                <div class="text-sm muted">Result</div>
                <div class="text-xs text-slate-500">Paid responses appear here</div>
              </div>
            </div>

            <div id="noResult"
              class="p-6 mt-2 rounded-md bg-[#06101b] border border-slate-800 text-slate-500">
              No result yet — choose a symbol and pay to unlock.
            </div>

            <div id="output" class="mt-4 text-slate-200"></div>
          </div>

        </div>
      </section>

      <!-- RIGHT SIDE: Original premium layout -->
      <section class="space-y-4">
        <div class="p-4 rounded-xl bg-[#071024] border border-slate-800">

          <div id="resultCard" class="grid grid-cols-2 gap-4">

            <!-- LEFT SIGNAL CARD -->
            <div class="p-4 bg-[#061623] rounded-xl border border-slate-800">
              <div id="resultSignal" class="text-4xl font-extrabold text-white">—</div>
              <div id="resultSymbol" class="text-sm muted mt-2">—</div>
              <div id="resultDesc" class="mt-3 text-sm text-slate-300">
                Select a symbol to get AI insights.
              </div>
            </div>

            <!-- RIGHT DONUT -->
            <div class="relative p-4 bg-[#061623] rounded-xl border border-slate-800 flex items-center justify-center">

              <svg id="donutSvg" viewBox="0 0 36 36" class="w-36 h-36">
                <defs>
                  <linearGradient id="gradLow" x1="0" x2="1">
                    <stop offset="0%" stop-color="#ef4444"/>
                    <stop offset="100%" stop-color="#f97316"/>
                  </linearGradient>
                  <linearGradient id="gradMid" x1="0" x2="1">
                    <stop offset="0%" stop-color="#f59e0b"/>
                    <stop offset="100%" stop-color="#eab308"/>
                  </linearGradient>
                  <linearGradient id="gradHigh" x1="0" x2="1">
                    <stop offset="0%" stop-color="#10b981"/>
                    <stop offset="100%" stop-color="#06b6d4"/>
                  </linearGradient>
                </defs>

                <g transform="translate(18,18)">
                  <circle r="15" cx="0" cy="0"
                    fill="none" stroke="#0b1220" stroke-width="6"/>
                  <circle id="donutArc"
                    r="15" cx="0" cy="0"
                    fill="none" stroke="#7c3aed" stroke-width="6"
                    stroke-linecap="round"
                    stroke-dasharray="0 100"
                    transform="rotate(-90)"/>
                </g>
              </svg>

              <div class="donut-center">
                <div id="convictionNum" class="text-2xl font-bold text-white">--</div>
                <div id="signalStrengthLabel" class="text-xs muted mt-1">N/A</div>
              </div>

            </div>

          </div>
        </div>

        <div class="p-3 rounded-xl bg-[#071024] border border-slate-800 text-sm muted">
          Donut shows conviction: Low / Medium / Strong. Grey = no conviction provided.
        </div>
      </section>

    </div>
  </div>

  <!-- SCRIPT -->
  <script>
  //////////////////////////////////////
  // ICONS — using cryptologos.cc
  //////////////////////////////////////
  const ICONS = {
    BTC:"https://cryptologos.cc/logos/bitcoin-btc-logo.png",
    ETH:"https://cryptologos.cc/logos/ethereum-eth-logo.png",
    BNB:"https://cryptologos.cc/logos/bnb-bnb-logo.png",
    SOL:"https://cryptologos.cc/logos/solana-sol-logo.png",
    XRP:"https://cryptologos.cc/logos/xrp-xrp-logo.png",
    ADA:"https://cryptologos.cc/logos/cardano-ada-logo.png",
    AVAX:"https://cryptologos.cc/logos/avalanche-avax-logo.png",
    DOGE:"https://cryptologos.cc/logos/dogecoin-doge-logo.png",
    TRX:"https://cryptologos.cc/logos/tron-trx-logo.png",
    DOT:"https://cryptologos.cc/logos/polkadot-new-dot-logo.png",
    MATIC:"https://cryptologos.cc/logos/polygon-matic-logo.png",
    LINK:"https://cryptologos.cc/logos/chainlink-link-logo.png",
    LTC:"https://cryptologos.cc/logos/litecoin-ltc-logo.png",
    UNI:"https://cryptologos.cc/logos/uniswap-uni-logo.png",
    BCH:"https://cryptologos.cc/logos/bitcoin-cash-bch-logo.png",
    XLM:"https://cryptologos.cc/logos/stellar-xlm-logo.png",
    OP:"https://cryptologos.cc/logos/optimism-ethereum-op-logo.png",
    ARB:"https://cryptologos.cc/logos/arbitrum-arb-logo.png",
    FIL:"https://cryptologos.cc/logos/filecoin-fil-logo.png",
    ATOM:"https://cryptologos.cc/logos/cosmos-atom-logo.png"
  };

  //////////////////////////////////////
  // SERVICE CONFIG
  //////////////////////////////////////
  const SERVICE_PRICES = {
    "signal-simple": 0.10,
    "signal": 0.50,
    "analysis-simple": 0.10,
    "analysis": 1.00
  };

  const SERVICE_DESCRIPTIONS = {
    "signal-simple": {
      title: "Unlock AI signal for SYMBOL",
      subtitle: "BUY / SELL / HOLD + conviction score"
    },
    "signal": {
      title: "Unlock full AI signal for SYMBOL",
      subtitle: "With detailed explanation"
    },
    "analysis-simple": {
      title: "MARKET ANALYSIS",
      subtitle: "Short-term market outlook"
    },
    "analysis": {
      title: "MARKET ANALYSIS",
      subtitle: "Deep market analysis & forecasting"
    }
  };

  // DOM refs
  const symbolInput = document.getElementById("symbolInput");
  const typeahead = document.getElementById("typeahead");
  const selectedSymbolEl = document.getElementById("selectedSymbol");
  const selectedIconSmall = document.getElementById("selectedIconSmall");
  const selectedIconLarge = document.getElementById("selectedIconLarge");
  const serviceSelect = document.getElementById("service");
  const priceBadge = document.getElementById("priceBadge");
  const descTitle = document.getElementById("descTitle");
  const descSub = document.getElementById("descSub");
  const payBtn = document.getElementById("payBtn");
  const payLabel = document.getElementById("payLabel");
  const resultSignalEl = document.getElementById("resultSignal");
  const resultSymbolEl = document.getElementById("resultSymbol");
  const resultDescEl = document.getElementById("resultDesc");
  const donutArc = document.getElementById("donutArc");
  const convictionNumEl = document.getElementById("convictionNum");
  const strengthLabelEl = document.getElementById("signalStrengthLabel");
  const output = document.getElementById("output");

  let selected = null;
  const SYMBOLS = Object.keys(ICONS);

  //////////////////////////////////////
  // TYPEAHEAD
  //////////////////////////////////////
  symbolInput.addEventListener("input", (e)=>{
    const q = e.target.value.trim().toUpperCase();
    if (!q) { typeahead.classList.add("hidden"); return; }

    const matches = SYMBOLS.filter(s=>s.startsWith(q)).slice(0,12);

    typeahead.innerHTML = matches.map(sym => {
      const ico = ICONS[sym] || "";
      const img = ico ? `<img src="${ico}" class="inline-block w-5 h-5 mr-2 align-middle"/>` : "";
      return `<div class="px-3 py-2 hover:bg-[#0b1a2a] cursor-pointer flex items-center">${img}<span>${sym}</span></div>`;
    }).join("");

    typeahead.classList.remove("hidden");
  });

  typeahead.addEventListener("click", e=>{
    const item = e.target.closest("div");
    if (!item) return;
    const sym = item.textContent.trim();
    selectSym(sym);
  });

  //////////////////////////////////////
  // SELECT SYMBOL
  //////////////////////////////////////
  function selectSym(sym){
    selected = sym;
    selectedSymbolEl.textContent = sym;
    symbolInput.value = sym;
    typeahead.classList.add("hidden");
    payBtn.disabled = false;

    const ico = ICONS[sym];
    if (ico){
      selectedIconSmall.src = ico;
      selectedIconLarge.src = ico;
      selectedIconSmall.classList.remove("hidden");
      selectedIconLarge.classList.remove("hidden");
    } else {
      selectedIconSmall.classList.add("hidden");
      selectedIconLarge.classList.add("hidden");
    }

    const svc = serviceSelect.value;
    const price = SERVICE_PRICES[svc];
    priceBadge.innerText = `${price.toFixed(2)} USDC`;

    const d = SERVICE_DESCRIPTIONS[svc];
    descTitle.textContent = d.title.replace("SYMBOL", sym);
    descSub.textContent = d.subtitle;
  }

  //////////////////////////////////////
  // SERVICE SELECT CHANGE
  //////////////////////////////////////
  serviceSelect.addEventListener("change", ()=>{
    if (!selected) return;

    const svc = serviceSelect.value;
    const d = SERVICE_DESCRIPTIONS[svc];
    descTitle.textContent = d.title.replace("SYMBOL", selected);
    descSub.textContent = d.subtitle;

    const price = SERVICE_PRICES[svc];
    priceBadge.innerText = `${price.toFixed(2)} USDC`;
  });

  //////////////////////////////////////
  // DONUT
  //////////////////////////////////////
  function clamp(n){ return Math.max(0, Math.min(100,n)); }

  function updateDonut(score){
    const v = clamp(Math.round(score));
    donutArc.style.strokeDasharray = `${v} ${100-v}`;
    convictionNumEl.textContent = v;
    convictionNumEl.style.color = "#fff";

    if (v >= 80){
      donutArc.style.stroke = "url(#gradHigh)";
      strengthLabelEl.textContent = "STRONG";
      strengthLabelEl.style.color = "#34d399";
    } else if (v >= 50){
      donutArc.style.stroke = "url(#gradMid)";
      strengthLabelEl.textContent = "MEDIUM";
      strengthLabelEl.style.color = "#f59e0b";
    } else {
      donutArc.style.stroke = "url(#gradLow)";
      strengthLabelEl.textContent = "LOW";
      strengthLabelEl.style.color = "#ef4444";
    }
  }

  function updateDonutNeutral(){
    donutArc.style.strokeDasharray = "0 100";
    donutArc.style.stroke = "#475569";
    convictionNumEl.textContent = "--";
    convictionNumEl.style.color = "#94a3b8";
    strengthLabelEl.textContent = "N/A";
    strengthLabelEl.style.color = "#94a3b8";
  }

  //////////////////////////////////////
  // UNIFIED RESULT RENDERER
  //////////////////////////////////////
  function showUnifiedResult(service, result){
    let signal = null;
    let conviction = null;
    let timestamp = null;
    let symbol = null;
    let description = "";

    if (service === "signal-simple"){
      signal = (result.signal || "SIGNAL").toUpperCase();
      conviction = result.conviction ?? null;
      symbol = result.symbol || selected;
      timestamp = result.timestamp || Date.now();
      description = result.explanation || `AI signal indicates ${signal} for ${symbol}.`;
    }
    else if (service === "signal"){
      signal = (result.signal || "SIGNAL").toUpperCase();
      conviction = result.conviction ?? null;
      symbol = result.symbol || selected;
      timestamp = result.timestamp || Date.now();
      description = result.explanation || result.report || "";
    }
    else if (service === "analysis-simple"){
      signal = "MARKET ANALYSIS";
      conviction = null;
      symbol = result.symbol || selected;
      timestamp = result.timestamp || Date.now();
      description = result.market || result.analysis || "No analysis provided.";
    }
    else if (service === "analysis"){
      const t = result.toon || {};
      signal = (t.signal || "MARKET ANALYSIS").toUpperCase();
      conviction = t.conviction ?? null;
      symbol = t.symbol || selected;
      timestamp = t.timestamp || Date.now();
      description = result.report || "";
    }
    else {
      signal = result.signal || "RESULT";
      conviction = result.conviction ?? null;
      symbol = result.symbol || selected;
      timestamp = result.timestamp || Date.now();
      description = result.report || JSON.stringify(result);
    }

    resultSignalEl.textContent = signal;
    resultSymbolEl.textContent = `${symbol} · ${new Date(timestamp).toLocaleString()}`;
    resultDescEl.textContent = description;

    if (conviction === null || conviction === undefined){
      updateDonutNeutral();
    } else {
      updateDonut(conviction);
    }

    output.innerHTML = "";
    document.getElementById("noResult").classList.add("hidden");
  }

  //////////////////////////////////////
  // PREPARE PAYMENT + SIGNING + SUBMIT PROOF
  //////////////////////////////////////
  async function preparePayment(symbol, service){
    const r = await fetch(`/prepare-payment?symbol=${symbol}&service=${service}`);
    return r.json();
  }

  async function submitProof(signedXPayment, symbol, service){
    const r = await fetch("/submit-proof", {
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({ signedXPayment, symbol, service })
    });
    const txt = await r.text();
    try { return JSON.parse(txt); } catch { return txt; }
  }

  async function signWithMetaMask(accept, payTo, amount){
    if (!window.ethereum) throw new Error("MetaMask not found");

    await window.ethereum.request({ method:"eth_requestAccounts" });
    const accounts = await window.ethereum.request({ method:"eth_accounts" });
    const payer = accounts[0];

    const asset = accept.asset;
    const maxAmount = accept.maxAmountRequired;
    const chainId = 8453;

    const domain = {
      name: accept.extra?.name || "USD Coin",
      version: accept.extra?.version || "2",
      chainId,
      verifyingContract: asset.toLowerCase()
    };

    const nonce = "0x" + [...crypto.getRandomValues(new Uint8Array(32))]
      .map(x=>x.toString(16).padStart(2,"0")).join("");

    const deadline = Math.floor(Date.now()/1000) + 3600;

    const types = {
      EIP712Domain:[
        {name:"name",type:"string"},
        {name:"version",type:"string"},
        {name:"chainId",type:"uint256"},
        {name:"verifyingContract",type:"address"}
      ],
      TransferWithAuthorization:[
        {name:"from",type:"address"},
        {name:"to",type:"address"},
        {name:"value",type:"uint256"},
        {name:"validAfter",type:"uint256"},
        {name:"validBefore",type:"uint256"},
        {name:"nonce",type:"bytes32"}
      ]
    };

    const message = {
      from: payer,
      to: payTo,
      value: maxAmount,
      validAfter: 0,
      validBefore: deadline,
      nonce
    };

    const data = {
      types,
      domain,
      primaryType:"TransferWithAuthorization",
      message
    };

    const signature = await window.ethereum.request({
      method:"eth_signTypedData_v4",
      params:[payer, JSON.stringify(data)]
    });

    return {
      x402Version:1,
      scheme:"exact",
      network:"base",
      payload:{
        signature,
        authorization:{
          from:payer,
          to:asset,      // USDC contract as authorizer to minimize risk warnings
          value:String(maxAmount),
          validAfter:"0",
          validBefore:String(deadline),
          nonce
        }
      }
    };
  }

  //////////////////////////////////////
  // PAY BUTTON HANDLER
  //////////////////////////////////////
  payBtn.addEventListener("click", async ()=>{
    if (!selected) return alert("Select a symbol first");

    try {
      payBtn.disabled = true;
      payLabel.textContent = "Preparing payment…";

      const svc = serviceSelect.value;
      const prep = await preparePayment(selected, svc);
      const accept = prep.accept;

      payLabel.textContent = "Waiting for signature…";

      const signed = await signWithMetaMask(
        accept,
        accept.payTo,
        accept.maxAmountRequired
      );

      payLabel.textContent = "Submitting proof…";

      const result = await submitProof(signed, selected, svc);

      payLabel.textContent = "Done";
      showUnifiedResult(svc, result);

    } catch (err){
      console.error(err);
      alert("Payment failed: "+err.message);
      payLabel.textContent = "Error";
    }

    payBtn.disabled = false;
  });

  //////////////////////////////////////
  // INIT
  //////////////////////////////////////
  (function init(){
    const svc = serviceSelect.value;
    priceBadge.innerText = `${SERVICE_PRICES[svc].toFixed(2)} USDC`;
    const d = SERVICE_DESCRIPTIONS[svc];
    descTitle.textContent = d.title;
    descSub.textContent = d.subtitle;
  })();
  </script>
</body>
</html>
